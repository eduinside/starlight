<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‹¬ì˜ ìœ„ìƒ ê´€ì°° ì‹œë®¬ë ˆì´í„°</title>
    <style>
        :root {
            --bg-base: #030509;
            --panel-bg: rgba(21, 25, 43, 0.85);
            --text-color: #e0e6ed;
            --accent-color: #4cc9f0;
            --moon-lit: #fdfdfd;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-base);
            background-image: 
                radial-gradient(1px 1px at 20px 30px, #fff, rgba(0,0,0,0)),
                radial-gradient(1px 1px at 40px 70px, #fff, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 50px 160px, #ddd, rgba(0,0,0,0)),
                radial-gradient(1px 1px at 80px 120px, #fff, rgba(0,0,0,0)),
                radial-gradient(1px 1px at 110px 210px, #fff, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 150px 30px, #fff, rgba(0,0,0,0)),
                radial-gradient(1px 1px at 190px 90px, #ddd, rgba(0,0,0,0)),
                radial-gradient(1px 1px at 240px 10px, #fff, rgba(0,0,0,0));
            background-repeat: repeat;
            background-size: 400px 400px;
            color: var(--text-color);
            font-family: 'Pretendard', -apple-system, system-ui, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            transition: background-color 0.8s ease;
            overflow-x: hidden;
        }

        .dashboard {
            width: 95%;
            max-width: 1240px;
            display: grid;
            grid-template-columns: 440px 1fr;
            gap: 25px;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* Simulation Layout (Right Side) */
        .visual-section {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .card {
            background-color: var(--panel-bg);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.08);
            transition: transform 0.3s ease;
        }

        .main-display {
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .moon-canvas-container {
            position: relative;
            margin-bottom: 25px;
        }

        /* 3D Orbit Display */
        .orbit-display {
            padding: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            perspective: 1000px;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5), 0 20px 50px rgba(0,0,0,0.4);
            transform: translateZ(0);
        }

        /* 4. 'ì²œì²´ ìœ„ì¹˜ ì‹œë®¬ë ˆì´ì…˜' í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ì¡°ì • (ìœ„ì¹˜ ì´ë™ ëŒ€ì‘) */
        .orbit-label {
            font-size: 0.95rem;
            color: #8d99ae;
            margin-top: 15px; /* ìœ„ìª½ ì—¬ë°± ì¶”ê°€ (ìº”ë²„ìŠ¤ ì•„ë˜ë¡œ ì´ë™í–ˆìœ¼ë¯€ë¡œ) */
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        /* Right Panel Info (Swapped to Left) */
        .info-section {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .info-card {
            padding: 25px;
            height: fit-content; /* ìµœì†Œ ë†’ì´ ì œê±°í•˜ì—¬ ì½˜í…ì¸ ì— ë§ì¶¤ */
        }

        /* 3. ì‚¬ì´ë“œë°” ìƒë‹¨ ì •ë³´ ê°€ìš´ë° ì •ë ¬ì„ ìœ„í•œ ì»¨í…Œì´ë„ˆ */
        .moon-status-header {
            text-align: center;
            margin-bottom: 10px;
        }

        .phase-title {
            font-size: 2.4rem;
            font-weight: 800;
            color: var(--accent-color);
            margin: 0 0 8px 0;
            text-shadow: 0 0 15px rgba(76, 201, 240, 0.4);
        }

        .moon-age-text {
            font-size: 1.15rem;
            color: #bdc3c7;
            margin-bottom: 15px; /* ê°„ê²© ì•½ê°„ ì¡°ì • */
        }

        .guide-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        /* ê´€ì¸¡ ë°©í–¥ ì„¹ì…˜ ê³ ì • ë†’ì´ */
        .obs-direction-box {
            min-height: 100px;
        }

        /* ê´€ì¸¡ í¬ì¸íŠ¸ ì„¹ì…˜ ê³ ì • ë†’ì´ */
        .obs-points-box {
            min-height: 140px;
        }

        .guide-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .guide-title {
            font-weight: 700;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }

        .guide-content {
            font-size: 0.92rem;
            line-height: 1.4; 
            color: #bdc3c7;
        }

        /* 2. Sky Simulation Box - ì•„ë˜ ì˜ì—­ ì¶•ì†Œ */
        .sky-sim-container {
            background: linear-gradient(180deg, #0a1020 0%, #152040 100%);
            border-radius: 12px;
            padding: 12px 12px 8px 12px; /* í•˜ë‹¨ íŒ¨ë”© ë” ì¶•ì†Œ */
            margin-top: 10px;
            border: 1px solid rgba(255,255,255,0.05);
            text-align: center;
        }
        
        .sky-sim-label {
            font-size: 0.8rem;
            color: #4cc9f0;
            margin-bottom: 8px; /* ë§ˆì§„ ì¶•ì†Œ */
            font-weight: 600;
        }

        /* ì‹œë®¬ë ˆì´ì…˜ ì„¤ëª… í…ìŠ¤íŠ¸ ë§ˆì§„ ì¡°ì • */
        #skySimDesc {
            font-size: 0.85rem; 
            color: #bdc3c7; 
            margin-top: 6px; /* ë§ˆì§„ ì¶•ì†Œ */
            line-height: 1.3;
        }

        .direction-tag {
            display: inline-flex;
            background: rgba(76, 201, 240, 0.2);
            color: var(--accent-color);
            padding: 3px 10px;
            border-radius: 5px;
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 0;
        }

        /* Controls */
        .controls {
            padding: 25px;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            box-sizing: border-box;
            background: rgba(0,0,0,0.2);
        }

        .btn-row {
            display: flex;
            gap: 12px;
            align-items: center;
            width: 100%;
        }

        input[type="date"] {
            background-color: #2b3040;
            border: 1px solid #3f4455;
            color: white;
            padding: 12px;
            border-radius: 10px;
            flex-grow: 1;
            cursor: pointer;
            font-family: inherit;
            outline: none;
        }

        .btn {
            background-color: var(--accent-color);
            color: #05070a;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-secondary {
            background-color: #3f4455;
            color: white;
        }

        .btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .btn:active { transform: translateY(0); }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: #2b3040;
            border-radius: 3px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px; height: 22px;
            background: var(--accent-color);
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid #15192b;
            box-shadow: 0 0 10px rgba(76, 201, 240, 0.5);
        }

        @media (max-width: 1000px) {
            .dashboard { grid-template-columns: 1fr; }
            .info-card { min-height: auto; }
        }
    </style>
</head>
<body>

    <div class="dashboard">
        <!-- Information Section (Left) -->
        <div class="info-section">
            <div class="card info-card">
                <!-- 3. ì‚¬ì´ë“œë°” ìƒë‹¨ ì •ë³´ ê°€ìš´ë° ì •ë ¬ -->
                <div class="moon-status-header">
                    <div style="color:#8d99ae; font-size:0.9rem; margin-bottom: 5px;">í˜„ì¬ ë‹¬ì˜ ìƒíƒœ</div>
                    <h1 class="phase-title" id="phaseName">ë³´ë¦„ë‹¬</h1>
                    <div class="moon-age-text" id="moonAgeInfo">ì›”ë ¹ 14.8ì¼ (ìŒë ¥ 15ì¼ê²½)</div>
                </div>

                <div class="guide-section obs-direction-box">
                    <div class="guide-header">
                        <div class="guide-title">ğŸ“ ê´€ì¸¡ ë°©í–¥</div>
                        <div id="observationDirection" class="direction-tag">ë‚¨ìª½ í•˜ëŠ˜ (ìì •)</div>
                    </div>
                    <div id="observationSky" class="guide-content">
                        í•´ ì§ˆ ë…˜ ë™ìª½ì—ì„œ ë– ì˜¬ë¼ ìì • ë¬´ë µ ë‚¨ìª½ í•˜ëŠ˜ì—ì„œ ê°€ì¥ ë†’ê²Œ ë³´ì´ë©°, ìƒˆë²½ì— ì„œìª½ìœ¼ë¡œ ì§‘ë‹ˆë‹¤.
                    </div>
                </div>

                <div class="guide-section obs-points-box">
                    <div class="guide-header">
                        <div class="guide-title">ğŸ” ì£¼ìš” ê´€ì¸¡ í¬ì¸íŠ¸</div>
                    </div>
                    <ul id="observationPoints" class="guide-content" style="padding-left: 18px; margin: 0;">
                        <li>ë‹¬ì´ ê°€ì¥ ë°ì•„ ë§¨ëˆˆì´ë‚˜ ìŒì•ˆê²½ ê´€ì¸¡ì— ì¢‹ìŠµë‹ˆë‹¤.</li>
                        <li>'í† ë¼ ëª¨ì–‘'ì´ë¼ ë¶ˆë¦¬ëŠ” ë‹¬ì˜ ë¬´ëŠ¬ë¥¼ ê°€ì¥ ì„ ëª…í•˜ê²Œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                    </ul>
                </div>

                <div class="guide-section">
                    <div class="guide-header">
                        <div class="guide-title" id="skySimTitle">ğŸ•’ ì´ˆì €ë… ë‹¬ì˜ ìœ„ì¹˜</div>
                    </div>
                    <!-- 2. ì•„ë˜ ì˜ì—­ ì¶•ì†Œëœ ì‹œë®¬ë ˆì´ì…˜ ì»¨í…Œì´ë„ˆ -->
                    <div class="sky-sim-container">
                        <div class="sky-sim-label" id="skySimLabel">ì‹œë®¬ë ˆì´ì…˜ ì¤‘ì¸ ë‚ ì§œì˜ ì´ˆì €ë… í•˜ëŠ˜ ëª¨ìŠµ</div>
                        <canvas id="skySimCanvas" width="320" height="120"></canvas>
                        <div id="skySimDesc">
                            ë³´ë¦„ë‹¬ì€ ì´ˆì €ë…ì— ë™ìª½ í•˜ëŠ˜ì—ì„œ ë§‰ ë– ì˜¤ë¦…ë‹ˆë‹¤.
                        </div>
                    </div>
                </div>
            </div>

            <div class="card info-card" style="padding: 20px; min-height: auto;">
                <div class="guide-title">ğŸ’¡ ì•Œì•„ë‘ê¸°</div>
                <div class="guide-content" style="font-size: 0.85rem; margin-top: 10px; line-height: 1.4;">
                    ë‹¬ì˜ ëª¨ì–‘ì€ íƒœì–‘-ì§€êµ¬-ë‹¬ì˜ ê¸°í•˜í•™ì  ìœ„ì¹˜ì— ë”°ë¼ ê²°ì •ë©ë‹ˆë‹¤. ë³¸ ì‹œë®¬ë ˆì´ì…˜ì€ ë¶ë°˜êµ¬ ê´€ì¸¡ ì‹œì ì„ ê¸°ì¤€ìœ¼ë¡œ í•˜ë©°, ì¬ìƒ ì†ë„ëŠ” ì„¸ë°€í•œ ê´€ì°°ì„ ìœ„í•´ ì‹¤ì œë³´ë‹¤ ë§¤ìš° ëŠë¦¬ê²Œ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
                </div>
            </div>
        </div>

        <!-- Visual Section (Right) -->
        <div class="visual-section">
            <div class="card main-display">
                <div class="moon-canvas-container">
                    <canvas id="moonCanvas" width="340" height="340"></canvas>
                </div>
                <div class="controls">
                    <div class="btn-row">
                        <input type="date" id="dateInput">
                        <button class="btn" id="todayBtn">ì˜¤ëŠ˜</button>
                        <button class="btn btn-secondary" id="playBtn">â–¶ ì¬ìƒ</button>
                    </div>
                    <input type="range" id="phaseSlider" min="0" max="29.53" step="0.01">
                </div>
            </div>

            <div class="card orbit-display">
                <!-- 4. 'ì²œì²´ ìœ„ì¹˜ ì‹œë®¬ë ˆì´ì…˜' í…ìŠ¤íŠ¸ë¥¼ ì‹œë®¬ë ˆì´ì…˜(Canvas) ì•„ë˜ë¡œ ì´ë™ -->
                <canvas id="orbitCanvas" width="550" height="220"></canvas>
                <div class="orbit-label">ì²œì²´ ìœ„ì¹˜ ì‹œë®¬ë ˆì´ì…˜ (ìœ„ì—ì„œ ë³¸ ëª¨ìŠµ)</div>
            </div>
        </div>
    </div>

    <script>
        const moonCanvas = document.getElementById('moonCanvas');
        const mCtx = moonCanvas.getContext('2d');
        const orbitCanvas = document.getElementById('orbitCanvas');
        const oCtx = orbitCanvas.getContext('2d');
        const skySimCanvas = document.getElementById('skySimCanvas');
        const sCtx = skySimCanvas.getContext('2d');

        const phaseNameEl = document.getElementById('phaseName');
        const moonAgeInfoEl = document.getElementById('moonAgeInfo');
        const obsDirectionEl = document.getElementById('observationDirection');
        const obsSkyEl = document.getElementById('observationSky');
        const obsPointsEl = document.getElementById('observationPoints');
        const skySimDescEl = document.getElementById('skySimDesc');
        const skySimLabelEl = document.getElementById('skySimLabel');
        const dateInput = document.getElementById('dateInput');
        const phaseSlider = document.getElementById('phaseSlider');
        const playBtn = document.getElementById('playBtn');

        let isPlaying = false;
        let animationId = null;
        let moonSurfacePattern = null;
        let currentSimDate = new Date();

        const SYNODIC_MONTH = 29.53058867;
        // ê¸°ì¡´ ë‹¨ìˆœ EPOCH ë°©ì‹ ì œê±° -> Julian Date ê³„ì‚°ìœ¼ë¡œ ëŒ€ì²´

        function init() {
            createMoonTexture();
            setToday();
            
            dateInput.addEventListener('change', () => {
                stopPlayback();
                currentSimDate = new Date(dateInput.value);
                calculateFromDate(currentSimDate);
            });

            document.getElementById('todayBtn').addEventListener('click', setToday);
            
            phaseSlider.addEventListener('input', () => {
                stopPlayback();
                const age = parseFloat(phaseSlider.value);
                update(age, false); 
            });

            playBtn.addEventListener('click', togglePlayback);
            
            calculateFromDate(currentSimDate);
        }

        function createMoonTexture() {
            const buffer = document.createElement('canvas');
            buffer.width = 400; buffer.height = 400;
            const bCtx = buffer.getContext('2d');
            bCtx.fillStyle = '#e5e5e5';
            bCtx.beginPath(); bCtx.arc(200, 200, 190, 0, Math.PI*2); bCtx.fill();
            
            for(let i=0; i<25; i++) {
                bCtx.fillStyle = 'rgba(130, 130, 140, 0.25)';
                bCtx.beginPath();
                bCtx.arc(Math.random()*400, Math.random()*400, Math.random()*35+10, 0, Math.PI*2);
                bCtx.fill();
            }
            moonSurfacePattern = bCtx.createPattern(buffer, 'no-repeat');
        }

        function setToday() {
            stopPlayback();
            const now = new Date();
            currentSimDate = now;
            syncDateInput(now);
            calculateFromDate(now);
        }

        function syncDateInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            dateInput.value = `${year}-${month}-${day}`;
        }

        // ê³¼í•™ì  ê·¼ê±°: Julian Date(ìœ¨ë¦¬ìš°ìŠ¤ì¼)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì²œë¬¸í•™ì ìœ¼ë¡œ ì •ë°€í•œ í‰ê·  ì´ê°(Mean Elongation) ê³„ì‚°
        // ê¸°ì¡´ì˜ ë‹¨ìˆœ ì°¨ì´ ê³„ì‚°(diffDays % 29.53)ì€ ìˆ˜ì‹­ ë…„ ë‹¨ìœ„ì—ì„œ ì˜¤ì°¨ê°€ ë°œìƒí•  ìˆ˜ ìˆìŒ.
        // ì´ ë°©ì‹ì€ J2000.0(2000ë…„ 1ì›” 1.5ì¼)ì„ ê¸°ì¤€ìœ¼ë¡œ ë‹¬ì˜ ê¶¤ë„ ìš´ë™ì„ ë” ì •í™•íˆ ë°˜ì˜í•¨.
        function getJulianDate(date) {
            return (date.getTime() / 86400000) - (date.getTimezoneOffset() / 1440) + 2440587.5;
        }

        function calculateFromDate(date) {
            const jd = getJulianDate(date);
            // J2000.0 ë¶€í„° ê²½ê³¼í•œ ì„¸ê¸° (Julian Centuries)
            const T = (jd - 2451545.0) / 36525;
            
            // ë‹¬ì˜ í‰ê·  ì´ê° (Mean Elongation of the Moon): D
            // ê³µì‹: D = 297.85019 + 445267.111403*T - 0.0019142*T^2 + T^3/189474
            let D = 297.85019 + 445267.111403 * T - 0.0019142 * T * T + T * T * T / 189474;
            
            // 0~360ë„ë¡œ ì •ê·œí™”
            D = D % 360;
            if (D < 0) D += 360;
            
            // ì´ê°(D)ì„ ê¸°ì¤€ìœ¼ë¡œ ì›”ë ¹(Age) ê³„ì‚°
            // D=0ë„(ì‚­) -> Age=0, D=180ë„(ë§) -> Age=14.76...
            const age = (D / 360) * SYNODIC_MONTH;
            
            update(age, true);
        }

        function togglePlayback() {
            isPlaying = !isPlaying;
            if (isPlaying) {
                playBtn.innerHTML = "|| ì •ì§€";
                animate();
            } else {
                stopPlayback();
            }
        }

        function stopPlayback() {
            isPlaying = false;
            playBtn.innerHTML = "â–¶ ì¬ìƒ";
            if (animationId) cancelAnimationFrame(animationId);
        }

        function animate() {
            if (!isPlaying) return;
            currentSimDate.setTime(currentSimDate.getTime() + (0.44 * 60 * 60 * 1000));
            syncDateInput(currentSimDate);
            calculateFromDate(currentSimDate);
            animationId = requestAnimationFrame(animate);
        }

        function update(age, syncSlider = true) {
            if (syncSlider) phaseSlider.value = age;
            const phase = age / SYNODIC_MONTH;
            
            const info = getMoonInfo(age);
            phaseNameEl.textContent = info.name;
            moonAgeInfoEl.textContent = `ì›”ë ¹ ${age.toFixed(1)}ì¼ (ìŒë ¥ ${Math.floor(age)+1}ì¼ê²½)`;
            obsDirectionEl.textContent = info.dir;
            obsSkyEl.textContent = info.sky;
            obsPointsEl.innerHTML = info.points.map(p => `<li>${p}</li>`).join('');
            skySimDescEl.textContent = info.skySim;

            const month = currentSimDate.getMonth() + 1;
            const day = currentSimDate.getDate();
            skySimLabelEl.textContent = `${month}ì›” ${day}ì¼ì˜ ì´ˆì €ë… í•˜ëŠ˜ ëª¨ìŠµ`;

            // 1. ìŒë ¥ 15ì¼ì— ê°€ê¹Œì›Œì§€ë©´ ë°°ê²½ì´ ë°ì•„ì¡Œë‹¤ê°€ ì–´ë‘ì›Œì§€ëŠ” ë¡œì§ ê°•í™”
            // illumination: 0(New Moon) ~ 1(Full Moon)
            const illumination = phase <= 0.5 ? phase * 2 : (1 - phase) * 2;
            // ê¸°ì¡´ 4+(illum*14) -> 4+(illum*24) ë¡œ ë³€ê²½í•˜ì—¬ ë°ê¸° ë³€í™”í­ í™•ëŒ€
            const bgBrightness = 4 + (illumination * 24); 
            document.body.style.backgroundColor = `hsl(220, 35%, ${bgBrightness}%)`;

            drawMoon(age);
            drawOrbit(age);
            drawSkySim(age);
        }

        function getMoonInfo(age) {
            const p = age / SYNODIC_MONTH;
            if (p < 0.03 || p > 0.97) return {
                name: "ì‚­ (New Moon)", dir: "ê´€ì¸¡ ë¶ˆê°€", 
                sky: "íƒœì–‘ê³¼ ê°™ì€ ë°©í–¥ì— ìˆì–´ ì§€êµ¬ì—ì„œ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤.",
                points: ["ë‹¬ì´ íƒœì–‘ê³¼ í•¨ê»˜ ëœ¨ê³  ì§€ê¸° ë•Œë¬¸ì— ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "ì´ ì‹œê¸° ì „í›„ë¡œ ê°œê¸°ì¼ì‹ì´ ì¼ì–´ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤."],
                skySim: "ì‚­ì—ëŠ” ì´ˆì €ë…ì—ë„ ë‹¬ì´ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤."
            };
            if (p < 0.22) return {
                name: "ì´ˆìŠ¹ë‹¬", dir: "ì €ë… ì„œìª½ í•˜ëŠ˜",
                sky: "í•´ ì§„ ì§í›„ ì„œìª½ í•˜ëŠ˜ ë‚®ì€ ê³³ì—ì„œ ì ì‹œ ë³´ì´ë‹¤ê°€ ê³§ ì§‘ë‹ˆë‹¤.",
                points: ["ëˆˆì¹ ëª¨ì–‘ì˜ ì•„ì£¼ ê°€ëŠ” ë‹¬ì„ ê´€ì°°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", "ì§€êµ¬ì¡°(Earthshine) í˜„ìƒì„ ë³´ê¸° ê°€ì¥ ì¢‹ì€ ì‹œê¸°ì…ë‹ˆë‹¤."],
                skySim: "ì´ˆì €ë…ì— ì„œìª½ ì§€í‰ì„  ê·¼ì²˜ì—ì„œ ë‚®ê²Œ ë³´ì…ë‹ˆë‹¤."
            };
            if (p < 0.28) return {
                name: "ìƒí˜„ë‹¬", dir: "ì €ë… ë‚¨ìª½ í•˜ëŠ˜",
                sky: "ë‚®ì— ë– ì„œ í•´ ì§ˆ ë…˜ ë‚¨ìª½ í•˜ëŠ˜ì— ë³´ì´ë©°, ìì • ë¬´ë µ ì„œìª½ìœ¼ë¡œ ì§‘ë‹ˆë‹¤.",
                points: ["ë‹¬ì˜ ì˜¤ë¥¸ìª½ ë°˜ì´ ë°ê²Œ ë³´ì…ë‹ˆë‹¤.", "í•´ì§ˆ ë¬´ë µ ë‚¨ìª½ í•˜ëŠ˜ ë†’ì€ ê³³ì—ì„œ ê°€ì¥ ì˜ ë³´ì…ë‹ˆë‹¤."],
                skySim: "ì´ˆì €ë…ì— ë‚¨ìª½ í•˜ëŠ˜ ë†’ì€ ê³³ì— ìœ„ì¹˜í•©ë‹ˆë‹¤."
            };
            if (p < 0.47) return {
                name: "ì°¨ê°€ëŠ” ë‹¬", dir: "ë°¤ ë‚¨ë™ìª½ í•˜ëŠ˜",
                sky: "ì˜¤í›„ì— ë– ì˜¬ë¼ ë°¤ìƒˆë„ë¡ ë°ê²Œ ë¹›ë‚˜ë©° ìƒˆë²½ì— ì§‘ë‹ˆë‹¤.",
                points: ["ë³´ë¦„ë‹¬ì´ ë˜ê¸° ì§ì „ì˜ ë°°ë¶€ë¥¸ ëª¨ì–‘ì…ë‹ˆë‹¤.", "ë‹¬ì˜ ë°”ë‹¤ ì§€í˜•ì´ ì…ì²´ì ìœ¼ë¡œ ë³´ì´ê¸° ì‹œì‘í•©ë‹ˆë‹¤."],
                skySim: "ì´ˆì €ë…ì— ë‚¨ë™ìª½ í•˜ëŠ˜ì—ì„œ ë†’ì´ ë–  ìˆìŠµë‹ˆë‹¤."
            };
            if (p < 0.53) return {
                name: "ë³´ë¦„ë‹¬ (Full Moon)", dir: "ë°¤ìƒˆë„ë¡ (ë‚¨ìª½)",
                sky: "í•´ ì§ˆ ë•Œ ë™ìª½ì—ì„œ ë– ì„œ, ìì •ì— ë‚¨ìª½, í•´ ëœ° ë•Œ ì„œìª½ìœ¼ë¡œ ì§‘ë‹ˆë‹¤.",
                points: ["ë‹¬ì˜ ì „ë©´ì´ ë°ê²Œ ë¹›ë‚˜ ë°¤ìƒˆë„ë¡ ì„¸ìƒì„ ë¹„ì¶¥ë‹ˆë‹¤.", "ë‹¬ì˜ ì „ì²´ì ì¸ ì§€í˜•ì„ ê°ìƒí•˜ê¸° ê°€ì¥ ì¢‹ì€ ì‹œê¸°ì…ë‹ˆë‹¤."],
                skySim: "ì´ˆì €ë…ì— ë™ìª½ ì§€í‰ì„ ì—ì„œ ë§‰ ë– ì˜¤ë¦…ë‹ˆë‹¤."
            };
            if (p < 0.72) return {
                name: "ì´ì§€ëŸ¬ì§€ëŠ” ë‹¬", dir: "ì‹¬ì•¼ ë‚¨ì„œìª½ í•˜ëŠ˜",
                sky: "ì €ë… ëŠ¦ê²Œ ë– ì˜¬ë¼ ìƒˆë²½ ë‚´ë‚´ ë‚¨ìª½ê³¼ ì„œìª½ í•˜ëŠ˜ì„ ë¹„ì¶¥ë‹ˆë‹¤.",
                points: ["ì™¼ìª½ ë¶€ë¶„ì´ ì¡°ê¸ˆì”© ê¹ì´ê¸° ì‹œì‘í•˜ëŠ” ìœ„ìƒì…ë‹ˆë‹¤.", "ìƒˆë²½ ì¼ì° ê´€ì¸¡í•˜ê¸° ì¢‹ì€ ëŒ€ìƒì…ë‹ˆë‹¤."],
                skySim: "ì´ˆì €ë…ì—ëŠ” ì•„ì§ ì§€í‰ì„  ì•„ë˜ì— ìˆì–´ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤."
            };
            if (p < 0.78) return {
                name: "í•˜í˜„ë‹¬", dir: "ìƒˆë²½ ë‚¨ìª½ í•˜ëŠ˜",
                sky: "ìì • ë¬´ë µ ë™ìª½ì—ì„œ ë– ì„œ, í•´ ëœ° ë¬´ë µ ë‚¨ìª½ í•˜ëŠ˜ì—ì„œ ë³´ì…ë‹ˆë‹¤.",
                points: ["ë‹¬ì˜ ì™¼ìª½ ë°˜ì´ ë°ê²Œ ë³´ì…ë‹ˆë‹¤.", "ì´ë¥¸ ì•„ì¹¨ ì„œìª½ í•˜ëŠ˜ì—ì„œë„ ë‹¬ì„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."],
                skySim: "ì´ˆì €ë…ì—ëŠ” ë³´ì´ì§€ ì•Šìœ¼ë©° ìì •ì¯¤ ë™ìª½ì—ì„œ ëœ¹ë‹ˆë‹¤."
            };
            return {
                name: "ê·¸ë¯ë‹¬", dir: "ìƒˆë²½ ë™ìª½ í•˜ëŠ˜",
                sky: "í•´ ëœ¨ê¸° ì§ì „ ë™ìª½ í•˜ëŠ˜ ë‚®ì€ ê³³ì—ì„œ ì ê¹ ë³´ì´ë‹¤ í•´ì™€ í•¨ê»˜ ëœ¹ë‹ˆë‹¤.",
                points: ["ê°€ì¥ ê°€ëŠë‹¤ë€ ì™¼ìª½ ëˆˆì¹ ëª¨ì–‘ì˜ ë‹¬ì…ë‹ˆë‹¤.", "ë™íŠ¸ê¸° ì „ ì§§ì€ ì‹œê°„ ë™ì•ˆë§Œ ê´€ì¸¡ ê°€ëŠ¥í•œ ì‹ ë¹„ë¡œìš´ ëª¨ìŠµì…ë‹ˆë‹¤."],
                skySim: "ì´ˆì €ë…ì—ëŠ” ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤."
            };
        }

        function drawMoon(age) {
            const r = 150; const cx = 170; const cy = 170;
            mCtx.clearRect(0,0,340,340);
            
            mCtx.beginPath(); mCtx.arc(cx,cy,r,0,Math.PI*2);
            mCtx.fillStyle = '#0d111d'; mCtx.fill();

            const phase = age / SYNODIC_MONTH;
            mCtx.save();
            mCtx.beginPath();
            
            if (phase <= 0.5) {
                mCtx.arc(cx, cy, r, -Math.PI/2, Math.PI/2, false);
                const s = 1 - (phase / 0.25);
                if (phase < 0.25) mCtx.ellipse(cx, cy, r*s, r, 0, Math.PI/2, -Math.PI/2, true);
                else mCtx.ellipse(cx, cy, r*Math.abs(s), r, 0, Math.PI/2, -Math.PI/2, false);
            } else {
                mCtx.arc(cx, cy, r, Math.PI/2, -Math.PI/2, false);
                const s = (phase - 0.75) / 0.25;
                if (phase < 0.75) mCtx.ellipse(cx, cy, r*Math.abs(s), r, 0, -Math.PI/2, Math.PI/2, false);
                else mCtx.ellipse(cx, cy, r*s, r, 0, -Math.PI/2, Math.PI/2, true);
            }
            mCtx.clip();
            mCtx.translate(cx-200, cy-200);
            mCtx.fillStyle = moonSurfacePattern; mCtx.fillRect(0,0,400,400);
            mCtx.restore();

            const illum = phase <= 0.5 ? phase*2 : (1-phase)*2;
            mCtx.shadowBlur = 25 * illum;
            mCtx.shadowColor = "rgba(255,255,255,0.4)";
            mCtx.strokeStyle = "rgba(255,255,255,0.15)";
            mCtx.lineWidth = 1;
            mCtx.stroke();
        }

        function drawOrbit(age) {
            oCtx.clearRect(0,0,550,220);
            const cx = 130; const cy = 110;
            
            // 1. íƒœì–‘
            oCtx.save();
            const sunX = 500, sunY = 110;
            const sunGrd = oCtx.createRadialGradient(sunX, sunY, 10, sunX, sunY, 45);
            sunGrd.addColorStop(0, "#fffbd5");
            sunGrd.addColorStop(0.3, "#ffcc33");
            sunGrd.addColorStop(1, "transparent");
            oCtx.fillStyle = sunGrd;
            oCtx.beginPath(); oCtx.arc(sunX, sunY, 45, 0, Math.PI*2); oCtx.fill();
            
            oCtx.strokeStyle = "rgba(255, 204, 51, 0.5)";
            oCtx.lineWidth = 2;
            for(let i=0; i<12; i++) {
                const ang = (i / 12) * Math.PI * 2;
                oCtx.beginPath();
                oCtx.moveTo(sunX + Math.cos(ang)*25, sunY + Math.sin(ang)*25);
                oCtx.lineTo(sunX + Math.cos(ang)*40, sunY + Math.sin(ang)*40);
                oCtx.stroke();
            }
            oCtx.fillStyle = "#ffcc33";
            oCtx.font = "bold 13px sans-serif";
            oCtx.fillText("íƒœì–‘", sunX - 12, sunY + 65);
            oCtx.restore();

            // 2. ë¦¬ì–¼í•œ ì§€êµ¬
            const earthR = 26;
            oCtx.save();
            oCtx.shadowColor = "rgba(100, 200, 255, 0.8)";
            oCtx.shadowBlur = 18;
            oCtx.beginPath(); oCtx.arc(cx, cy, earthR + 1, 0, Math.PI * 2);
            oCtx.fillStyle = "rgba(10, 20, 40, 0.8)"; oCtx.fill();
            oCtx.shadowBlur = 0;
            
            oCtx.beginPath(); oCtx.arc(cx, cy, earthR, 0, Math.PI * 2);
            oCtx.fillStyle = "#02040a"; oCtx.fill();

            oCtx.save();
            oCtx.beginPath(); oCtx.arc(cx, cy, earthR, -Math.PI / 2, Math.PI / 2, false);
            oCtx.clip();
            
            const oceanGrd = oCtx.createRadialGradient(cx + 10, cy - 10, 2, cx, cy, earthR);
            oceanGrd.addColorStop(0, "#3a9fff");
            oceanGrd.addColorStop(0.6, "#1a66b4");
            oceanGrd.addColorStop(1, "#0a3a7a");
            oCtx.fillStyle = oceanGrd;
            oCtx.fillRect(cx - earthR, cy - earthR, earthR * 2, earthR * 2);

            oCtx.fillStyle = "#55a630";
            oCtx.beginPath(); oCtx.ellipse(cx+10, cy-6, 14, 8, 0.4, 0, Math.PI*2); oCtx.fill();
            oCtx.beginPath(); oCtx.ellipse(cx+4, cy-12, 10, 6, -0.2, 0, Math.PI*2); oCtx.fill();
            oCtx.beginPath(); oCtx.ellipse(cx+8, cy+10, 11, 14, -0.1, 0, Math.PI*2); oCtx.fill();
            
            oCtx.fillStyle = "#f0f8ff";
            oCtx.beginPath(); oCtx.ellipse(cx+5, cy-22, 12, 5, 0.1, 0, Math.PI*2); oCtx.fill();
            
            oCtx.fillStyle = "rgba(255, 255, 255, 0.35)";
            oCtx.beginPath(); oCtx.ellipse(cx+12, cy-14, 18, 5, 0.2, 0, Math.PI*2); oCtx.fill();
            oCtx.beginPath(); oCtx.ellipse(cx+2, cy+7, 14, 4, -0.4, 0, Math.PI*2); oCtx.fill();
            oCtx.restore(); 

            oCtx.beginPath(); oCtx.arc(cx, cy, earthR, 0, Math.PI * 2);
            const glossGrd = oCtx.createLinearGradient(cx - earthR, cy - earthR, cx + earthR, cy + earthR);
            glossGrd.addColorStop(0, "rgba(255,255,255,0.15)");
            glossGrd.addColorStop(0.4, "rgba(255,255,255,0)");
            glossGrd.addColorStop(1, "rgba(0,0,0,0.3)");
            oCtx.fillStyle = glossGrd;
            oCtx.fill();
            oCtx.strokeStyle = "rgba(120, 210, 255, 0.4)"; oCtx.lineWidth = 1.2; oCtx.stroke();
            oCtx.restore();

            // 3. ë‹¬ ê¶¤ë„
            oCtx.beginPath(); oCtx.ellipse(cx, cy, 110, 60, 0, 0, Math.PI*2);
            oCtx.strokeStyle = "rgba(255,255,255,0.18)"; oCtx.setLineDash([6, 4]);
            oCtx.stroke();
            oCtx.setLineDash([]);

            // 4. ë‹¬ ìœ„ì¹˜ ê³„ì‚° (ë¶ë°˜êµ¬ ê¸°ì¤€: ì‹œê³„ ë°˜ëŒ€ ë°©í–¥ ê³µì „)
            // ì‚­(0)ì¼ ë•Œ íƒœì–‘ ë°©í–¥(ì˜¤ë¥¸ìª½)ì—ì„œ ì‹œì‘í•˜ì—¬ ë°˜ì‹œê³„ë¡œ ê³µì „
            const angle = -(age / SYNODIC_MONTH) * Math.PI * 2; 
            const mx = cx + Math.cos(angle) * 110;
            const my = cy + Math.sin(angle) * 60;

            const moonR = 12;
            oCtx.save();
            oCtx.beginPath(); oCtx.arc(mx, my, moonR, 0, Math.PI*2);
            oCtx.fillStyle = "#0d111d"; oCtx.fill();
            oCtx.strokeStyle = "rgba(255,255,255,0.5)"; oCtx.lineWidth = 1; oCtx.stroke();

            // ë‹¬ì˜ ë°ì€ ë©´ì€ í•­ìƒ íƒœì–‘ ë°©í–¥(ì˜¤ë¥¸ìª½)
            oCtx.beginPath(); oCtx.arc(mx, my, moonR, -Math.PI/2, Math.PI/2, false);
            oCtx.clip();
            oCtx.fillStyle = "#fdfdfd"; oCtx.fill();
            oCtx.restore();
            
            oCtx.fillStyle = "#4cc9f0"; oCtx.font = "bold 13px sans-serif";
            oCtx.shadowColor = "black"; oCtx.shadowBlur = 4;
            oCtx.fillText("ë‹¬", mx - 6, my - 18);
            oCtx.shadowBlur = 0;
        }

        function drawSkySim(age) {
            sCtx.clearRect(0,0,320,120);
            sCtx.beginPath();
            sCtx.moveTo(20, 100);
            sCtx.lineTo(300, 100);
            sCtx.strokeStyle = "rgba(255,255,255,0.2)";
            sCtx.stroke();

            sCtx.fillStyle = "#8d99ae";
            sCtx.font = "10px sans-serif";
            sCtx.fillText("ë™(East)", 20, 115);
            sCtx.fillText("ë‚¨(South)", 145, 115);
            sCtx.fillText("ì„œ(West)", 270, 115);

            const p = age / SYNODIC_MONTH;
            let angle = -1;
            // ì´ˆì €ë…(í•´ ì§ˆ ë…˜) ê¸°ì¤€:
            // ì‚­(0)~ìƒí˜„(0.25)~ë³´ë¦„(0.5) ê¹Œì§€ëŠ” ì„œ->ë‚¨->ë™ ìˆœìœ¼ë¡œ ìœ„ì¹˜ ì´ë™
            if (p <= 0.5) angle = 270 - (p / 0.5) * 250;
            
            // ìˆ˜ì •: ìŒë ¥ 29~30ì¼(ê·¸ë¯)ì€ í•´ë³´ë‹¤ ë¨¼ì € ì§€ë¯€ë¡œ ì´ˆì €ë…ì— ë³´ì´ì§€ ì•Šì•„ì•¼ í•¨.
            // ë”°ë¼ì„œ 0.5(ë³´ë¦„) ì´í›„ë¡œëŠ” í•´ ì§ˆ ë•Œ ë‹¬ì´ ì§€í‰ì„  ì•„ë˜ì— ìˆìœ¼ë¯€ë¡œ ê·¸ë¦¬ì§€ ì•ŠìŒ.

            if (angle !== -1 && angle < 300) {
                const mx = angle;
                const my = 100 - Math.sin((angle-20)/250 * Math.PI) * 60;
                sCtx.beginPath(); sCtx.arc(mx, my, 8, 0, Math.PI*2);
                sCtx.fillStyle = "rgba(255,255,255,0.15)"; sCtx.fill();
                
                sCtx.save();
                sCtx.beginPath(); sCtx.arc(mx, my, 6, 0, Math.PI*2); sCtx.clip();
                sCtx.fillStyle = "#111"; sCtx.fill();
                
                sCtx.beginPath();
                if (p <= 0.5) {
                    sCtx.arc(mx, my, 6, -Math.PI/2, Math.PI/2, false);
                    const s = 1 - (p / 0.25);
                    if (p < 0.25) sCtx.ellipse(mx, my, 6*s, 6, 0, Math.PI/2, -Math.PI/2, true);
                    else sCtx.ellipse(mx, my, 6*Math.abs(s), 6, 0, Math.PI/2, -Math.PI/2, false);
                } else {
                    sCtx.arc(mx, my, 6, Math.PI/2, -Math.PI/2, false);
                    const s = (p - 0.75) / 0.25;
                    if (p < 0.75) sCtx.ellipse(mx, my, 6*Math.abs(s), 6, 0, -Math.PI/2, Math.PI/2, false);
                    else sCtx.ellipse(mx, my, 6*s, 6, 0, -Math.PI/2, Math.PI/2, true);
                }
                sCtx.fillStyle = "#fff"; sCtx.fill();
                sCtx.restore();
                
                sCtx.shadowBlur = 10; sCtx.shadowColor = "white";
                sCtx.strokeStyle = "rgba(255,255,255,0.5)"; sCtx.stroke();
            } else {
                sCtx.fillStyle = "rgba(255,255,255,0.3)";
                sCtx.font = "italic 11px sans-serif";
                sCtx.fillText("ë‹¬ì´ ì§€í‰ì„  ì•„ë˜ì— ìˆìŠµë‹ˆë‹¤", 100, 60);
            }
        }

        window.onload = init;
    </script>
</body>
</html>